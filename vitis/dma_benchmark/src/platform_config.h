/**
 * @file platform_config.h
 * @brief VPK120 Platform Configuration for DMA Benchmark
 *
 * Memory map and hardware configuration for Versal VPK120 board.
 * Addresses are sourced from xparameters.h generated by Vitis 2023.2
 */

#ifndef PLATFORM_CONFIG_H
#define PLATFORM_CONFIG_H

#include <stdint.h>
#include "xparameters.h"

/*******************************************************************************
 * Memory Base Addresses (from xparameters.h)
 ******************************************************************************/

/* LPDDR4 Memory (2GB via NoC) - VPK120 on-board memory */
#ifdef XPAR_AXI_NOC_0_C0_DDR_LOW0_FPD_CCI_NOC_2_BASEADDR
    #define LPDDR4_BASE_ADDR        XPAR_AXI_NOC_0_C0_DDR_LOW0_FPD_CCI_NOC_2_BASEADDR
    #define LPDDR4_HIGH_ADDR        XPAR_AXI_NOC_0_C0_DDR_LOW0_FPD_CCI_NOC_2_HIGHADDR
#else
    #define LPDDR4_BASE_ADDR        0x00000000ULL
    #define LPDDR4_HIGH_ADDR        0x7FFFFFFFULL
#endif

#define LPDDR4_SIZE                 0x80000000ULL  /* 2GB */
#define LPDDR4_TEST_REGION_BASE     (LPDDR4_BASE_ADDR + 0x10000000ULL)  /* 256MB offset */
#define LPDDR4_TEST_REGION_SIZE     0x10000000ULL   /* 256MB test region */

/* OCM (On-Chip Memory - 256KB) */
#define OCM_BASE_ADDR               0xFFFC0000ULL
#define OCM_SIZE                    0x00040000ULL   /* 256KB */

/* DDR4 Memory - Not available on this design, use LPDDR4 addresses */
#define DDR4_BASE_ADDR              LPDDR4_BASE_ADDR
#define DDR4_SIZE                   LPDDR4_SIZE
#define DDR4_TEST_REGION_BASE       LPDDR4_TEST_REGION_BASE
#define DDR4_TEST_REGION_SIZE       LPDDR4_TEST_REGION_SIZE

/* PL BRAM - Not in this design */
#define PL_BRAM_BASE_ADDR           0xA0000000ULL
#define PL_BRAM_SIZE                0x00000000ULL   /* Not available */

/* PL URAM - Not in this design */
#define PL_URAM_BASE_ADDR           0xA0020000ULL
#define PL_URAM_SIZE                0x00000000ULL   /* Not available */

/*******************************************************************************
 * DMA Controller Base Addresses (from xparameters.h)
 ******************************************************************************/

/* AXI DMA - Stream DMA with MM2S/S2MM */
#ifdef XPAR_AXI_DMA_0_BASEADDR
    #define AXI_DMA_BASE_ADDR       XPAR_AXI_DMA_0_BASEADDR
#else
    #define AXI_DMA_BASE_ADDR       0xA4000000ULL
#endif
#define AXI_DMA_MM2S_CTRL_OFFSET    0x00
#define AXI_DMA_MM2S_STATUS_OFFSET  0x04
#define AXI_DMA_MM2S_CURDESC_OFFSET 0x08
#define AXI_DMA_MM2S_CURDESC_MSB_OFFSET 0x0C
#define AXI_DMA_MM2S_TAILDESC_OFFSET 0x10
#define AXI_DMA_MM2S_TAILDESC_MSB_OFFSET 0x14
#define AXI_DMA_MM2S_SA_OFFSET      0x18
#define AXI_DMA_MM2S_SA_MSB_OFFSET  0x1C
#define AXI_DMA_MM2S_LENGTH_OFFSET  0x28
#define AXI_DMA_S2MM_CTRL_OFFSET    0x30
#define AXI_DMA_S2MM_STATUS_OFFSET  0x34
#define AXI_DMA_S2MM_CURDESC_OFFSET 0x38
#define AXI_DMA_S2MM_CURDESC_MSB_OFFSET 0x3C
#define AXI_DMA_S2MM_TAILDESC_OFFSET 0x40
#define AXI_DMA_S2MM_TAILDESC_MSB_OFFSET 0x44
#define AXI_DMA_S2MM_DA_OFFSET      0x48
#define AXI_DMA_S2MM_DA_MSB_OFFSET  0x4C
#define AXI_DMA_S2MM_LENGTH_OFFSET  0x58
#define AXI_DMA_SG_CTL_OFFSET       0x2C

/* AXI CDMA - Memory-to-Memory DMA */
#ifdef XPAR_AXI_CDMA_0_BASEADDR
    #define AXI_CDMA_BASE_ADDR      XPAR_AXI_CDMA_0_BASEADDR
#else
    #define AXI_CDMA_BASE_ADDR      0xA4020000ULL
#endif
#define AXI_CDMA_CTRL_OFFSET        0x00
#define AXI_CDMA_STATUS_OFFSET      0x04
#define AXI_CDMA_CURDESC_OFFSET     0x08
#define AXI_CDMA_CURDESC_MSB_OFFSET 0x0C
#define AXI_CDMA_TAILDESC_OFFSET    0x10
#define AXI_CDMA_TAILDESC_MSB_OFFSET 0x14
#define AXI_CDMA_SA_OFFSET          0x18
#define AXI_CDMA_SA_MSB_OFFSET      0x1C
#define AXI_CDMA_DA_OFFSET          0x20
#define AXI_CDMA_DA_MSB_OFFSET      0x24
#define AXI_CDMA_BTT_OFFSET         0x28

/* AXI MCDMA - Multi-Channel DMA */
#ifdef XPAR_AXI_MCDMA_0_BASEADDR
    #define AXI_MCDMA_BASE_ADDR     XPAR_AXI_MCDMA_0_BASEADDR
#else
    #define AXI_MCDMA_BASE_ADDR     0xA4010000ULL
#endif
#define AXI_MCDMA_MM2S_CH_OFFSET    0x00
#define AXI_MCDMA_S2MM_CH_OFFSET    0x500
#define AXI_MCDMA_CHANNEL_SPACING   0x40
#define AXI_MCDMA_NUM_CHANNELS      4  /* Configured for 4 channels */

/* LPD DMA (ADMA/ZDMA) Base Addresses - PS Hard IP */
#ifdef XPAR_XZDMA_0_BASEADDR
    #define LPD_DMA_CH0_BASE_ADDR   XPAR_XZDMA_0_BASEADDR
#else
    #define LPD_DMA_CH0_BASE_ADDR   0xFFA80000ULL
#endif
#ifdef XPAR_XZDMA_1_BASEADDR
    #define LPD_DMA_CH1_BASE_ADDR   XPAR_XZDMA_1_BASEADDR
#else
    #define LPD_DMA_CH1_BASE_ADDR   0xFFA90000ULL
#endif
#ifdef XPAR_XZDMA_2_BASEADDR
    #define LPD_DMA_CH2_BASE_ADDR   XPAR_XZDMA_2_BASEADDR
#else
    #define LPD_DMA_CH2_BASE_ADDR   0xFFAA0000ULL
#endif
#ifdef XPAR_XZDMA_3_BASEADDR
    #define LPD_DMA_CH3_BASE_ADDR   XPAR_XZDMA_3_BASEADDR
#else
    #define LPD_DMA_CH3_BASE_ADDR   0xFFAB0000ULL
#endif
#ifdef XPAR_XZDMA_4_BASEADDR
    #define LPD_DMA_CH4_BASE_ADDR   XPAR_XZDMA_4_BASEADDR
#else
    #define LPD_DMA_CH4_BASE_ADDR   0xFFAC0000ULL
#endif
#ifdef XPAR_XZDMA_5_BASEADDR
    #define LPD_DMA_CH5_BASE_ADDR   XPAR_XZDMA_5_BASEADDR
#else
    #define LPD_DMA_CH5_BASE_ADDR   0xFFAD0000ULL
#endif
#ifdef XPAR_XZDMA_6_BASEADDR
    #define LPD_DMA_CH6_BASE_ADDR   XPAR_XZDMA_6_BASEADDR
#else
    #define LPD_DMA_CH6_BASE_ADDR   0xFFAE0000ULL
#endif
#ifdef XPAR_XZDMA_7_BASEADDR
    #define LPD_DMA_CH7_BASE_ADDR   XPAR_XZDMA_7_BASEADDR
#else
    #define LPD_DMA_CH7_BASE_ADDR   0xFFAF0000ULL
#endif
#define LPD_DMA_NUM_CHANNELS        8

/*******************************************************************************
 * Device IDs (from xparameters.h)
 ******************************************************************************/

#ifdef XPAR_AXICDMA_0_DEVICE_ID
    #define AXI_CDMA_DEVICE_ID      XPAR_AXICDMA_0_DEVICE_ID
#else
    #define AXI_CDMA_DEVICE_ID      0
#endif

#ifdef XPAR_AXIDMA_0_DEVICE_ID
    #define AXI_DMA_DEVICE_ID       XPAR_AXIDMA_0_DEVICE_ID
#else
    #define AXI_DMA_DEVICE_ID       0
#endif

#ifdef XPAR_MCDMA_0_DEVICE_ID
    #define AXI_MCDMA_DEVICE_ID     XPAR_MCDMA_0_DEVICE_ID
#else
    #define AXI_MCDMA_DEVICE_ID     0
#endif

#ifdef XPAR_XZDMA_0_DEVICE_ID
    #define LPD_DMA_DEVICE_ID       XPAR_XZDMA_0_DEVICE_ID
#else
    #define LPD_DMA_DEVICE_ID       0
#endif

/*******************************************************************************
 * Interrupt Configuration (from xparameters.h)
 ******************************************************************************/

/* PL to PS Interrupt IDs (GIC SPI) */
#ifdef XPAR_FABRIC_AXI_DMA_0_MM2S_INTROUT_INTR
    #define AXI_DMA_MM2S_IRQ_ID     XPAR_FABRIC_AXI_DMA_0_MM2S_INTROUT_INTR
#else
    #define AXI_DMA_MM2S_IRQ_ID     121
#endif

#ifdef XPAR_FABRIC_AXI_DMA_0_S2MM_INTROUT_INTR
    #define AXI_DMA_S2MM_IRQ_ID     XPAR_FABRIC_AXI_DMA_0_S2MM_INTROUT_INTR
#else
    #define AXI_DMA_S2MM_IRQ_ID     122
#endif

#ifdef XPAR_FABRIC_AXI_CDMA_0_CDMA_INTROUT_INTR
    #define AXI_CDMA_IRQ_ID         XPAR_FABRIC_AXI_CDMA_0_CDMA_INTROUT_INTR
#else
    #define AXI_CDMA_IRQ_ID         123
#endif

/* GIC controller */
#ifdef XPAR_SCUGIC_0_DEVICE_ID
    #define INTC_DEVICE_ID          XPAR_SCUGIC_0_DEVICE_ID
#else
    #define INTC_DEVICE_ID          0
#endif

/*******************************************************************************
 * Clock Frequencies
 ******************************************************************************/

#define PL_CLK0_FREQ_HZ             100000000ULL  /* 100 MHz (PL clock) */
#define PL_CLK1_FREQ_HZ             100000000ULL  /* 100 MHz */
#define APU_CLK_FREQ_HZ             1400000000ULL /* 1.4 GHz A72 */

/* Timer frequencies */
#define TTC_CLK_FREQ_HZ             100000000ULL  /* 100 MHz TTC clock */
#define PMU_CLK_FREQ_HZ             APU_CLK_FREQ_HZ

/*******************************************************************************
 * DMA Configuration Parameters
 ******************************************************************************/

/* AXI DMA configuration */
#ifdef XPAR_AXI_DMA_0_SG_LENGTH_WIDTH
    #define AXI_DMA_SG_LENGTH_WIDTH XPAR_AXI_DMA_0_SG_LENGTH_WIDTH
#else
    #define AXI_DMA_SG_LENGTH_WIDTH 26  /* bits, max 64MB */
#endif
#define AXI_DMA_DATA_WIDTH          128   /* bits */
#define AXI_DMA_ADDR_WIDTH          64    /* bits */
#define AXI_DMA_MAX_BURST_LEN       256   /* beats */
#define AXI_DMA_MAX_TRANSFER_SIZE   ((1ULL << AXI_DMA_SG_LENGTH_WIDTH) - 1)

/* AXI CDMA configuration */
#ifdef XPAR_AXICDMA_0_ADDR_WIDTH
    #define AXI_CDMA_ADDR_WIDTH     XPAR_AXICDMA_0_ADDR_WIDTH
#else
    #define AXI_CDMA_ADDR_WIDTH     64    /* bits */
#endif
#define AXI_CDMA_DATA_WIDTH         128   /* bits */
#define AXI_CDMA_MAX_BURST_LEN      256   /* beats */

/* AXI MCDMA configuration */
#define AXI_MCDMA_NUM_MM2S_CHANNELS 4
#define AXI_MCDMA_NUM_S2MM_CHANNELS 4
#define AXI_MCDMA_DATA_WIDTH        128   /* bits */
#define AXI_MCDMA_ADDR_WIDTH        64    /* bits */

/* LPD DMA configuration */
#define LPD_DMA_DATA_WIDTH          128   /* bits */
#define LPD_DMA_MAX_BURST_LEN       16    /* beats */

/*******************************************************************************
 * DMA Buffer Configuration
 ******************************************************************************/

/* Source and destination buffer regions in LPDDR4 */
#define DMA_SRC_BUFFER_BASE         (LPDDR4_BASE_ADDR + 0x10000000ULL)  /* 256MB offset */
#define DMA_DST_BUFFER_BASE         (LPDDR4_BASE_ADDR + 0x20000000ULL)  /* 512MB offset */
#define DMA_BUFFER_SIZE             0x10000000ULL  /* 256MB each */

/* Scatter-Gather descriptor region */
#define DMA_SG_DESC_BASE            (LPDDR4_BASE_ADDR + 0x30000000ULL)  /* 768MB offset */
#define DMA_SG_DESC_SIZE            0x00100000ULL  /* 1MB for descriptors */

/*******************************************************************************
 * Test Configuration
 ******************************************************************************/

/* Descriptor alignment requirement */
#define DESC_ALIGNMENT              64    /* bytes */

/* Buffer alignment for optimal DMA performance */
#define BUFFER_ALIGNMENT            64    /* bytes (cache line size) */

/* Maximum number of scatter-gather descriptors */
#define MAX_SG_DESCRIPTORS          256

/* Default number of test iterations */
#define DEFAULT_TEST_ITERATIONS     100

/* Warmup iterations (not counted in measurements) */
#define WARMUP_ITERATIONS           5

/*******************************************************************************
 * Memory Region Definitions for Tests
 ******************************************************************************/

typedef enum {
    MEM_REGION_DDR4 = 0,
    MEM_REGION_LPDDR4,
    MEM_REGION_OCM,
    MEM_REGION_BRAM,
    MEM_REGION_URAM,
    MEM_REGION_HOST,
    MEM_REGION_COUNT
} MemoryRegion_t;

/* Memory region descriptors */
typedef struct {
    const char* name;
    uint64_t base_addr;
    uint64_t size;
    uint64_t test_base;
    uint64_t test_size;
    uint32_t cacheable;
} MemoryRegionInfo_t;

/* Memory region table (defined in platform_config.c) */
extern const MemoryRegionInfo_t g_MemoryRegions[MEM_REGION_COUNT];

/* DMA Type Enumeration is defined in dma_benchmark.h to avoid duplication */

/*******************************************************************************
 * Function Prototypes
 ******************************************************************************/

/**
 * @brief Initialize platform hardware
 * @return 0 on success, negative error code on failure
 */
int platform_init(void);

/**
 * @brief Cleanup platform resources
 */
void platform_cleanup(void);

/**
 * @brief Get memory region information
 * @param region Memory region identifier
 * @return Pointer to memory region info, NULL if invalid
 */
const MemoryRegionInfo_t* platform_get_memory_info(MemoryRegion_t region);

/**
 * @brief Check if memory region is accessible
 * @param region Memory region identifier
 * @return 1 if accessible, 0 otherwise
 */
int platform_is_region_accessible(MemoryRegion_t region);

/* platform_get_dma_name is implemented in main.c as dma_type_to_string */

#endif /* PLATFORM_CONFIG_H */
