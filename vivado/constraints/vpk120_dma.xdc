################################################################################
# Versal DMA Benchmark - XDC Constraints
# Target: VPK120 (Versal Premium VP1202)
################################################################################

################################################################################
# PL Clock Constraints
################################################################################

# PL Reference Clock 0 (250 MHz) - Primary DMA clock
# Clock is generated by CIPS, this constraint is for reference
# create_clock -period 4.000 -name pl0_ref_clk [get_pins versal_cips_0/pl0_ref_clk]

# PL Reference Clock 1 (100 MHz) - Control interfaces
# create_clock -period 10.000 -name pl1_ref_clk [get_pins versal_cips_0/pl1_ref_clk]

# PL Reference Clock 2 (500 MHz) - High-speed operations (if used)
# create_clock -period 2.000 -name pl2_ref_clk [get_pins versal_cips_0/pl2_ref_clk]

################################################################################
# Clock Domain Crossings
################################################################################

# False paths for asynchronous reset synchronizers
set_false_path -to [get_pins -hierarchical -filter {NAME =~ */proc_sys_reset_*/inst/ACTIVE_LOW_PR_OUT_DFF*/D}]

# Allow for clock domain crossing in reset path
set_false_path -through [get_pins -hierarchical -filter {NAME =~ *aresetn*}]

################################################################################
# DMA Path Constraints
################################################################################

# AXI DMA timing exceptions for Scatter-Gather descriptor fetches
# These paths have built-in synchronization
set_false_path -from [get_cells -hierarchical -filter {NAME =~ *axi_dma_0*sg*}] \
               -to [get_cells -hierarchical -filter {NAME =~ *axi_dma_0*mm2s*}]

set_false_path -from [get_cells -hierarchical -filter {NAME =~ *axi_dma_0*sg*}] \
               -to [get_cells -hierarchical -filter {NAME =~ *axi_dma_0*s2mm*}]

# AXI CDMA timing exceptions
set_false_path -from [get_cells -hierarchical -filter {NAME =~ *axi_cdma_0*sg*}] \
               -to [get_cells -hierarchical -filter {NAME =~ *axi_cdma_0*datamover*}]

# AXI MCDMA timing exceptions for multi-channel arbitration
set_max_delay 8.0 -from [get_cells -hierarchical -filter {NAME =~ *axi_mcdma_0*arb*}] \
                  -to [get_cells -hierarchical -filter {NAME =~ *axi_mcdma_0*channel*}]

################################################################################
# Memory Controller Constraints
################################################################################

# DDR4 SODIMM timing - handled by NoC MC, no additional constraints needed
# LPDDR4 timing - handled by NoC MC, no additional constraints needed

################################################################################
# AXI Stream FIFO Constraints
################################################################################

# FIFO clock domain crossing paths are internally handled
# Set multicycle for FIFO read/write pointer synchronization
set_max_delay 8.0 -datapath_only \
    -from [get_cells -hierarchical -filter {NAME =~ *axis_data_fifo*wr_ptr*}] \
    -to [get_cells -hierarchical -filter {NAME =~ *axis_data_fifo*rd_ptr*}]

set_max_delay 8.0 -datapath_only \
    -from [get_cells -hierarchical -filter {NAME =~ *axis_data_fifo*rd_ptr*}] \
    -to [get_cells -hierarchical -filter {NAME =~ *axis_data_fifo*wr_ptr*}]

################################################################################
# BRAM/URAM Timing Constraints
################################################################################

# BRAM controller timing - relax for read data path
set_multicycle_path 2 -setup \
    -from [get_cells -hierarchical -filter {NAME =~ *blk_mem_gen*BRAM*}] \
    -to [get_cells -hierarchical -filter {NAME =~ *axi_bram_ctrl*}]

set_multicycle_path 1 -hold \
    -from [get_cells -hierarchical -filter {NAME =~ *blk_mem_gen*BRAM*}] \
    -to [get_cells -hierarchical -filter {NAME =~ *axi_bram_ctrl*}]

# URAM timing - additional cycle for URAM output register
set_multicycle_path 2 -setup \
    -from [get_cells -hierarchical -filter {NAME =~ *uram_mem*URAM*}] \
    -to [get_cells -hierarchical -filter {NAME =~ *uram_ctrl*}]

set_multicycle_path 1 -hold \
    -from [get_cells -hierarchical -filter {NAME =~ *uram_mem*URAM*}] \
    -to [get_cells -hierarchical -filter {NAME =~ *uram_ctrl*}]

################################################################################
# NoC Timing Constraints
################################################################################

# NoC paths are managed by the NoC compiler
# Add timing exceptions for NoC slave interface synchronization
set_false_path -from [get_cells -hierarchical -filter {NAME =~ *axi_noc*NMU*}] \
               -to [get_cells -hierarchical -filter {NAME =~ *axi_noc*NSU*}]

################################################################################
# Interrupt Path Constraints
################################################################################

# Interrupt consolidation paths
set_max_delay 10.0 -datapath_only \
    -from [get_cells -hierarchical -filter {NAME =~ *introut*}] \
    -to [get_cells -hierarchical -filter {NAME =~ *xlconcat_irq*}]

################################################################################
# Physical Constraints (Floorplanning Hints)
################################################################################

# Keep DMA logic close to NoC columns for better routing
# create_pblock pblock_dma
# add_cells_to_pblock [get_pblocks pblock_dma] [get_cells -hierarchical -filter {NAME =~ *axi_dma*}]
# add_cells_to_pblock [get_pblocks pblock_dma] [get_cells -hierarchical -filter {NAME =~ *axi_cdma*}]
# add_cells_to_pblock [get_pblocks pblock_dma] [get_cells -hierarchical -filter {NAME =~ *axi_mcdma*}]
# resize_pblock [get_pblocks pblock_dma] -add {SLICE_X0Y0:SLICE_X100Y300}

# Keep BRAM controllers near BRAM columns
# create_pblock pblock_bram
# add_cells_to_pblock [get_pblocks pblock_bram] [get_cells -hierarchical -filter {NAME =~ *axi_bram_ctrl*}]
# add_cells_to_pblock [get_pblocks pblock_bram] [get_cells -hierarchical -filter {NAME =~ *blk_mem_gen*}]

################################################################################
# Debug Constraints
################################################################################

# Mark nets for debug (ILA insertion)
# set_property MARK_DEBUG true [get_nets -hierarchical -filter {NAME =~ *axi_dma_0*mm2s*valid*}]
# set_property MARK_DEBUG true [get_nets -hierarchical -filter {NAME =~ *axi_dma_0*s2mm*valid*}]

################################################################################
# Power Optimization Constraints
################################################################################

# Enable block RAM power optimization
set_property BLOCK_POWER_OPT true [current_design]

# Enable DSP power optimization (if DSPs are used)
set_property DSP_POWER_OPT true [current_design]

################################################################################
# Bitstream Configuration
################################################################################

# Versal-specific bitstream settings
set_property BITSTREAM.GENERAL.COMPRESS TRUE [current_design]
set_property BITSTREAM.CONFIG.CONFIGRATE 63.8 [current_design]

################################################################################
# End of Constraints
################################################################################
